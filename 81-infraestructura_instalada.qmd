# Infraestructura Instalada {#anexo-infraestructura}

## Configuraci√≥n inicial del entorno (Pre-flight) {#sec-preflight}

Para automatizar el soporte de gr√°ficos y capturas sin configurar cada archivo individualmente, ejecute estos comandos en la terminal del contenedor `contenedor_sig_unal` inmediatamente despu√©s de iniciar los servicios con `docker compose up -d`:

| Categor√≠a | Comando de Configuraci√≥n | Prop√≥sito |
|:--- |:--- |:--- |
| **Soporte Base** | `apt-get update && apt-get install -y fonts-symbola wget` | Fuentes para emojis y herramienta de descarga de paquetes externos. |
| **Navegador** | `wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb && apt install -y ./google-chrome-stable_current_amd64.deb` | Instala Google Chrome (Bypass de Snap). Obligatorio para capturas de mapas en Docker. |
| **Automatizaci√≥n R** | `echo 'Sys.setenv(CHROMOTE_CHROME = "/usr/bin/google-chrome")' >> /usr/local/lib/R/etc/Rprofile.site` | Configura la ruta de Chrome para todo el sistema R de forma persistente. |
| **Seguridad Root** | `echo 'options(chromote.args = c("--no-sandbox", "--disable-gpu", "--headless"))' >> /usr/local/lib/R/etc/Rprofile.site` | Habilita el modo *headless* y evita bloqueos de *sandbox* al ejecutar como root. |
| **Librer√≠as R** | `Rscript -e "install.packages('webshot2', repos='https://cloud.r-project.org/')"` | Instala el motor de captura de widgets HTML y mapas de Leaflet. |
| **Librer√≠as Python**| `pip3 install selenium` | Habilita la automatizaci√≥n de capturas para visualizaciones din√°micas de Python. |
| **Librer√≠as Julia** | `julia -e 'using Pkg; Pkg.add(["FileIO", "ImageIO"])'` | Soporte esencial para procesar y exportar gr√°ficos en el ecosistema Julia. |

: Comandos de configuraci√≥n global del contenedor {#tbl-preflight}



### Ventajas de esta configuraci√≥n {#sec-ventajas}

Al usar el archivo `Rprofile.site`, hemos logrado que:

1.  **Limpieza:** Sus archivos `.qmd` solo contendr√°n c√≥digo de an√°lisis geogr√°fico, eliminando bloques de configuraci√≥n de sistema repetitivos.
2.  **Persistencia:** Cualquier usuario o script que inicie una sesi√≥n de R dentro de este contenedor heredar√° autom√°ticamente la capacidad de tomar capturas de pantalla.
3.  **Compatibilidad:** Quarto detectar√° `webshot2` y el navegador Chrome de forma nativa al renderizar a PDF.

### Notas de implementaci√≥n {#sec-notas-tecnicas}

::: {.callout-note}
#### ¬øPor qu√© Google Chrome y no Chromium?
En distribuciones basadas en Ubuntu 22.04 o superiores, el comando `apt install chromium-browser` instala una versi√≥n ligada a **Snap**, la cual no puede ejecutarse dentro de un contenedor Docker por restricciones de seguridad del kernel. La instalaci√≥n manual del paquete `.deb` de Google Chrome garantiza un binario funcional en `/usr/bin/google-chrome`.
:::

::: {.callout-important}
#### Importancia de ImageIO y FileIO en Julia
En Julia, estas librer√≠as act√∫an como los "drivers" de imagen. Sin ellas, aunque el c√≥digo genere un mapa o gr√°fico, Quarto no podr√° convertirlo a un formato que LaTeX entienda (como PNG), resultando en bloques vac√≠os en el PDF final.
:::

## Introducci√≥n a la infraestructura de datos

Este anexo constituye la gu√≠a t√©cnico para la gesti√≥n del entorno de desarrollo instalado. Es decir, informaci√≥n que describe y detalla los contenedores instalados (instalaci√≥n opci√≥n A), su estructura y funcionamiento, as√≠ mismo como la descripci√≥n y detalles adicionales de las dos instalaciones de QGIS (Instalaci√≥n Opci√≥n B) 

### Contenedores instalados (Instalaci√≥n Opci√≥n A)

#### Resumen de infraestructura docker {#sec-resumen-infra}

Antes de entrar en los detalles t√©cnicos, es vital entender el rol de los dos archivos maestros que sostienen su laboratorio geogr√°fico. 

| Archivo | Rol Cr√≠tico |
|:---|:--- |
| **`Dockerfile`** | **El "Qu√©" (La Receta):** Crea el entorno pol√≠glota desde cero, instala las librer√≠as de NASA/Copernicus y aplica la **"cirug√≠a" de OpenSSL** para que Julia sea estable en Ubuntu Noble. |
| **`docker-compose.yml`** | **El "C√≥mo" (La Orquesta):** Despliega los servicios, mapea los puertos externos (**8889**, **8788**, **5434**) y asegura que sus mapas y bases de datos no se borren gracias al volumen persistente (`postgis_data_unal`). |


::: {.callout-important}
##### Persistencia de Datos
Gracias al `docker-compose`, si su contenedor se apaga o se reinicia, los datos de su base de datos PostGIS **no se pierden**. El volumen nombrado act√∫a como un disco duro externo que sobrevive a cualquier ca√≠da del sistema.
:::

#### üß™ Bater√≠a de pruebas de integridad del docker

| ID | Comando de Verificaci√≥n (Docker) | Descripci√≥n |
|:---|:---|:---|
| 01 | `docker exec contenedor_sig_unal gdalinfo --version` | Verifica que el n√∫cleo de GDAL est√° activo. |
| 02 | `docker exec contenedor_sig_unal R -e "library(sf); st_point(c(0,0))"` | Prueba la librer√≠a `sf` y el motor de geometr√≠a en R. |
| 03 | `docker exec contenedor_sig_unal python3 -c "import geopandas; print(geopandas.__version__)"` | Verifica el stack espacial de Python. |
| 04 | `docker exec contenedor_sig_unal R -e "j_eval('sum([1, 2, 3])')"` | **Test Cr√≠tico:** Verifica la funci√≥n personalizada y el puente R -> Julia. |
| 05 | `docker exec contenedor_sig_unal R -e "j_plot('plot(rand(10))')"` | Prueba la generaci√≥n de gr√°ficos Julia capturados por R. |
| 06 | `docker exec contenedor_sig_unal julia -e 'using ArchGDAL; println(ArchGDAL.GDAL.gdalversioninfo("RELEASE_NAME"))'` | **Cirug√≠a Exitosa:** Confirma que Julia accede a GDAL del sistema (v3.12.1). |
| 07 | `docker exec contenedor_sig_unal R -e "library(RPostgres); dbConnect(Postgres(), host='db-postgis', dbname='sig_db_unal', user='profe_unal', password='geomatica2025')"` | Prueba la conexi√≥n R -> PostGIS (Interna). |
| 08 | `docker exec contenedor_sig_unal python3 -c "import psycopg2; conn = psycopg2.connect(host='db-postgis', dbname='sig_db_unal', user='profe_unal', password='geomatica2025'); print('Python PostGIS conectado ‚úÖ'); conn.close()"` | Prueba la conexi√≥n Python -> PostGIS (Interna). |
| 09 | `docker exec contenedor_sig_unal R -e "cat(whitebox::wbt_version())"` | Verifica que los binarios de WhiteboxTools est√°n instalados y accesibles. |
| 10 | `docker exec contenedor_sig_unal R -e "library(httpgd); print('Visor OK')"` | Verifica que el motor gr√°fico para VSCode est√° listo en el puerto `8787`. |

#### Configuraci√≥n de puertos y conectividad {#sec-puertos}

Para que su computadora (Host) pueda comunicarse con los servicios dentro del contenedor, hemos dise√±ado un sistema de "puentes" o mapeo de puertos. Esto evita conflictos si ya tiene instalados otros servidores de bases de datos o Jupyter en su PC.

| Servicio | Puerto en su PC (Host) | Puerto en Contenedor | Prop√≥sito | Acceso / Conexi√≥n |
|:---|:---:|:---:|:---|:---|
| **Jupyter Lab** | `8889` | `8888` | Programaci√≥n y Notebooks | `http://localhost:8889` |
| **Visor R (httpgd)** | `8788` | `8787` | Gr√°ficos de R y VSCode | `http://localhost:8788` |
| **PostGIS (DB)** | `5434` | `5432` | Base de Datos Espacial | `localhost:5434` |


#### üîë Credenciales de la base de datos {#sec-credenciales}

Utilice estos datos para configurar sus conexiones en QGIS, DBeaver o mediante c√≥digo (R/Python/Julia):

* **Base de Datos:** `sig_db_unal`
* **Usuario:** `profe_unal`
* **Contrase√±a:** `geomatica2025`
* **Host Interno:** `db-postgis` (Use este nombre √∫nicamente para conexiones **dentro** de sus scripts).


#### L√≥gica de arquitectura (Dockerfile y docker-compose) {#sec-arquitectura-puertos}

La configuraci√≥n del entorno se ha "blindado" t√©cnicamente para garantizar la estabilidad:

1.  **En el Dockerfile**: Se usan las instrucciones `EXPOSE 8888` y `EXPOSE 8787`. Esto le avisa a Docker que el contenedor tiene dos "puertas" abiertas internamente. Al fijar `httpgd.port = 8787`, nos aseguramos de que el visor de gr√°ficos de R no pelee con Jupyter por el mismo canal.
2.  **En el Docker-Compose**: 
    * **`8889:8888`**: Permite que este curso conviva con otras instalaciones de Jupyter (que suelen usar el 8888).
    * **`8788:8787`**: Habilita la conexi√≥n independiente de VSCode al visor de gr√°ficos de R.
    * **`5434:5432`**: Evita el choque con bases de datos locales (Postgres suele usar el 5432 o 5433).


#### Gu√≠a de acceso: El concepto de "lados" {#sec-guia-acceso}

Es fundamental entender desde d√≥nde est√° intentando conectar:

> ##### üåê Desde afuera (Su PC / Host)
> Es lo que usted configura en su navegador o en QGIS. Usted ve los puertos mapeados:
> * **Jupyter/Notebooks**: `http://localhost:8889` (usando el token `geomatica2025`).
> * **Base de Datos (QGIS/DBeaver)**: Host: `localhost`, Puerto: `5434`.

> ##### üê≥ Desde adentro (El Contenedor)
> Sus scripts de Python, R y Julia no saben que existe un mapeo externo. Dentro de su "casa" Docker, nada ha cambiado:
> * **PostGIS**: El c√≥digo debe buscar el puerto est√°ndar `5432` y el host `db-postgis`.
> * **httpgd**: El servidor de gr√°ficos sigue escuchando en el puerto interno `8787`.

::: {.callout-note}
##### Tip de Conexi√≥n
Si intenta conectar QGIS usando el puerto `5432` y falla, recuerde que el "puente" hacia el contenedor se construy√≥ espec√≠ficamente sobre el puerto **`5434`**.
:::
