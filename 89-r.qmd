# Adicionales Sobre R {#sec-anexo_r}

## Stack de R

Para el an√°lisis geoespacial en `R` (instalado dentro de los contenedores), utilizaremos un ecosistema robusto basado en el est√°ndar *Simple Features* y motores de alto rendimiento para datos r√°ster (rejilla - cuadr√≠culas).

| Paquete | Funcionalidad | Sitio web |
|:----------:|:------------------:|:--------------------------------:|
| `sf` | Geometr√≠as vectoriales (Simple Features) | <https://r-spatial.github.io/sf/> |
| `terra` | An√°lisis de datos espaciales (R√°ster/Vector) | <https://rspatial.github.io/terra/> |
| `stars` | Arreglos ordenados espacio-temporales (DataCubes) | <https://r-spatial.github.io/stars/> |
| `tidyverse` | Metapaquete para ciencia de datos | <https://www.tidyverse.org/> |
| `tidyterra` | M√©todos de tidyverse para terra | <https://dieghernan.github.io/tidyterra/> |

: Paquetes principales del stack espacial en R {#tbl-r-packages}

-   **`sf` (Simple Features)**: Es el est√°ndar moderno para el manejo de datos vectoriales. Representa las geometr√≠as como una columna especial en un *data frame*, permitiendo aplicar toda la potencia de manipulaci√≥n de tablas a objetos espaciales.
-   **`terra`**: Motor de alta eficiencia que reemplaza al antiguo paquete `raster`. Est√° optimizado para el manejo de grandes vol√∫menes de datos mediante objetos `SpatRaster` y `SpatVector`, permitiendo operaciones de √°lgebra de mapas y an√°lisis local de manera veloz.
-   **`stars` (Spatiotemporal Arrays)**: Especializada en el manejo de "cubos de datos" (rejillas con dimensiones de espacio, tiempo y m√∫ltiples atributos). Es la herramienta ideal para procesar series temporales de im√°genes satelitales o modelos clim√°ticos multidimensionales.
-   **`tidyterra`**: Extiende la gram√°tica de `ggplot2` y `tidyverse` hacia los objetos de `terra`. Permite visualizar mapas r√°ster de forma elegante y realizar tuber√≠as (`pipes`) de datos manteniendo la integridad espacial.

## Versiones instaladas del software

Versiones que deben quedar instaladas en el sistema R:

| Software | Tipo | Versi√≥n | Comando (desde terminal) | Comando (desde R) |
|:-|:-|:-|:------|:---------|
| `R` | Lenguaje | 4.5.2 | `R --version` | `R.version.string` |
| `GEOS` | Librer√≠a sistema | 3.12.1 | `geos-config --version` | `sf::sf_extSoftVersion()["GEOS"]` |
| `GDAL` | Librer√≠a sistema | 3.8.4 | `gdalinfo --version` | `sf::sf_extSoftVersion()["GDAL"]` |
| `PROJ` | Librer√≠a sistema | 9.4.0 | (no aplica / no disponible) | `sf::sf_extSoftVersion()["PROJ"]` |
| `sf` | Paquete | 1.0.23 | `R -q -e "packageVersion('sf')"` | `packageVersion("sf")` |
| `terra` | Paquete | 1.8.86 | `R -q -e "packageVersion('terra')"` | `packageVersion("terra")` |
| `stars` | Paquete | 0.7.0 | `R -q -e "packageVersion('stars')"` | `packageVersion("stars")` |

## Visualizaci√≥n interactiva con `httpgd` {#sec-httpgd-config}

Dado que nuestro entorno Docker es "headless" (sin monitor propio), utilizamos **`httpgd`** como un servidor gr√°fico intermedio. Este paquete captura las se√±ales de dibujo de R y las sirve a trav√©s de una URL que VSCode puede renderizar.

### Inicio del servidor gr√°fico
Cada vez que inicie una nueva sesi√≥n de R, debe despertar al servidor manualmente:

```r
# Inicia el motor gr√°fico
httpgd::hgd()

# Verifica el estado y el puerto asignado
httpgd::hgd_details()
```

### Resoluci√≥n de conflictos (el "fix" del puerto)
En nuestro contenedor, el puerto est√°ndar para gr√°ficos est√° mapeado al **8787**. Si al ejecutar `hgd_details()` nota que el sistema asign√≥ un puerto aleatorio o si el visor aparece en blanco, fuerce la conexi√≥n con la siguiente "receta":

```r
# Forzar host y puerto para compatibilidad con Docker
httpgd::hgd(host = "0.0.0.0", port = 8787, token = FALSE)
```


### Formas de ver sus gr√°ficos
Una vez el servidor est√° corriendo, tiene dos caminos para visualizar sus mapas:

| M√©todo | Comando / Acci√≥n | Ventaja |
| :--- | :--- | :--- |
| **Visor Interno** | `Ctrl + Shift + P` -> **Open httpgd viewer** | Mantiene todo dentro de una pesta√±a de VSCode. |
| **Navegador Externo** | `httpgd::hgd_browse()` | Ideal si trabaja con dos monitores para ver mapas en pantalla completa. |

::: {.callout-note}
#### ¬øPor qu√© `token = FALSE`?
Dentro del entorno seguro del contenedor, desactivamos el *token* para facilitar la conexi√≥n inmediata entre el servidor de R y el visor de VSCode sin que el firewall interno bloquee la petici√≥n por falta de credenciales.
:::

### Verificaci√≥n de salud
Si despu√©s de iniciar el servidor intenta graficar algo (ej: `plot(1:10)`) y no ve nada, ejecute `httpgd::hgd_details()`. Aseg√∫rese de que:
1.  **URL**: Apunte a `http://0.0.0.0:8787`.
2.  **Status**: Indique que est√° escuchando (*listening*).

### El Entorno interactivo (REPL) y motores gr√°ficos {#sec-repl-concept}

En el desarrollo cient√≠fico, el **REPL** (*Read-Eval-Print Loop*) es la consola interactiva que permite la "programaci√≥n exploratoria". Es el ciclo donde el sistema **lee** su instrucci√≥n, la **eval√∫a** mediante el motor correspondiente, **imprime** el resultado y queda en un **bucle** a la espera del siguiente comando.

En nuestro laboratorio pol√≠glota, la identidad visual del REPL es su br√∫jula para saber en qu√© lenguaje est√° operando:

| Lenguaje | ¬øC√≥mo se ve el REPL? | Caracter√≠sticas en este curso |
| :--- | :--- | :--- |
| **R** | `>` | Consola est√°ndar para procesos geoespaciales con `sf` o `terra`. |
| **Julia** | `julia>` | Entorno de alto rendimiento con modos de ayuda (`?`) y terminal (`;`). |
| **Python** | `>>>` | Consola b√°sica; se recomienda el uso de **IPython** para interactividad. |

La experiencia interactiva y el soporte gr√°fico dentro de **VSCode** dependen de la combinaci√≥n entre el motor de ejecuci√≥n y el dispositivo gr√°fico configurado en el contenedor:

| Lenguaje | Acceso / Contexto | Motor de Ejecuci√≥n | Dispositivo Gr√°fico | Soporte Inline |
| :--- | :--- | :--- | :--- | :---: |
| **R** | Nativo (Est√°tico) | R Extension | VSCode Plots (Pane) | ‚úÖ |
| **R** | Nativo (Interactivo) | R Extension | **httpgd** | ‚úÖ |
| **Julia** | Nativo (REPL) | VSCodeServer | VSCode Plots (Pane) | ‚úÖ |
| **Julia** | Interop (R-Bridge) | `JuliaConnectoR` | **httpgd** (v√≠a R) | ‚úÖ |
| **Python** | Interop (R-Bridge) | `reticulate` | R Device (**httpgd**) | ‚ùå / ‚ö†Ô∏è |
| **Python** | Nativo (Jupyter) | Jupyter kernel | Jupyter Viewer | ‚úÖ |

### El rol cr√≠tico de `httpgd` en R
Para R, no basta con tener la extensi√≥n instalada. El paquete **`httpgd`** act√∫a como un servidor web interno que captura los gr√°ficos generados en el contenedor y los "proyecta" en VSCode. 

* **¬øPor qu√© lo usamos?** Los dispositivos gr√°ficos tradicionales (como `X11` o `windows()`) no funcionan dentro de un contenedor Docker (*headless*). `httpgd` soluciona esto convirtiendo cada mapa en un elemento interactivo SVG/HTML renderizable.
* **Activaci√≥n**: Siempre debe iniciar su sesi√≥n de R ejecutando `httpgd::hgd()` para abrir este canal de comunicaci√≥n.

---

## Paquetes para comunicaci√≥n con Julia y Python {#sec-interoperabilidad}

Para que este ecosistema funcione, R act√∫a como el "director de orquesta" utilizando un motor de ejecuci√≥n y una serie de puentes que permiten la comunicaci√≥n fluida de datos entre lenguajes.

| Lenguaje / Funci√≥n | Paquete en R | Motor / Prop√≥sito | Estado |
| :--- | :--- | :--- | :---: |
| **Renderizado** | **`knitr`** | Motor maestro que orquesta la ejecuci√≥n de celdas en el documento | ‚úÖ |
| **Julia** | `JuliaConnectoR` | Comunicaci√≥n funcional estable con el kernel de Julia | ‚úÖ |
| **Python** | `reticulate` | Interoperabilidad de objetos y ejecuci√≥n de Python | ‚úÖ |
| **LSP (Soporte)** | `languageserver` | Autocompletado, IntelliSense y ayuda en tiempo real | ‚úÖ |

### El rol de `knitr`
Mientras que los paquetes act√∫an como puentes t√©cnicos, **`knitr`** es el encargado de leer el archivo `.qmd`, enviar las instrucciones a los motores respectivos y capturar los resultados (tablas, mapas, gr√°ficos) para integrarlos en el documento final. Sin `knitr`, la integraci√≥n pol√≠glota de Quarto no ser√≠a posible.

### Transici√≥n t√©cnica: De `JuliaCall` a `JuliaConnectoR`
En el dise√±o de este entorno, se tom√≥ la decisi√≥n t√©cnica de descartar el paquete `JuliaCall` en favor de **`JuliaConnectoR`**:

1. **El Problema**: `JuliaCall` presentaba inestabilidades al gestionar dependencias din√°micas compartidas (como `libcurl` o `libstdc++`) dentro del contenedor, causando cierres inesperados (*crashes*) de la sesi√≥n de R.
2. **La Sustituci√≥n**: Se seleccion√≥ **`JuliaConnectoR`** por su arquitectura m√°s limpia, que no interfiere con el entorno de Julia ya configurado en el sistema operativo.
3. **La Soluci√≥n**: La integraci√≥n se resolvi√≥ mediante una "inyecci√≥n" de c√≥digo en el archivo `Rprofile.site`, configurando autom√°ticamente la ruta del ejecutable en `$Sys.BINDIR$` y definiendo las funciones maestras **`j_eval()`** y **`j_plot()`**.


::: {.callout-tip}
#### üß† Regla de Oro del Curso
1.  **Julia y R**: Se operan de manera totalmente **interactiva** en VSCode (env√≠o de l√≠neas con `Ctrl+Enter`).
2.  **Python v√≠a reticulate**: Se utiliza primordialmente para el **renderizado (v√≠a knitr)** de informes finales. Para una programaci√≥n interactiva pura en Python, se recomienda el uso de los **Jupyter kernels**.
:::
